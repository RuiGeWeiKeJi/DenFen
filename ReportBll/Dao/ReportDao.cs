using System;
using System . Collections . Generic;
using System . Linq;
using System . Text;
using StudentMgr;
using System . Data;

namespace ReportBll . Dao
{
    public class ReportDao
    {
        /// <summary>
        /// 获取数据列表
        /// </summary>
        /// <returns></returns>
        public DataTable GetDataTable ( )
        {
            StringBuilder strSql = new StringBuilder ( );
            strSql . Append ( "SELECT DISTINCT DEA001,DEA002,DEA057,A.LOA011,A.LOA00301 LOA00301,A.LOA00302 LOA00302,A.LOA00301 LOA00303,C.HCB006 HCB00601,ISNULL(D.HCB006,0) HCB00602,ISNULL(E.HCB006,0) HCB00603,ISNULL(F.HCB006,0) HCB00604,DEA019,H.RCB008 RCB00801,I.RCB008 RCB00802,J.RCB008 RCB00803,K.RCB008 RCB00804,L.RCB008 RCB00805,M.RCB008 RCB00806,N.RCB008 RCB00807,O.RCB008 RCB00808,P.RCB008 RCB00809,Q.RCB008 RCB00810,R.RCB008 RCB00811,S.RCB008 RCB00812 FROM TPADEA LEFT JOIN (SELECT A.LOA001,A.LOA011,A.LOA003 LOA00301,B.LOA003 LOA00302 FROM (select LOA001,LOA011,SUM(LOA003) LOA003 from JSKLOA WHERE LOA002='BCP' GROUP BY LOA001,LOA011) A LEFT JOIN ( select LOA001,LOA011 ,SUM(LOA003) LOA003 from JSKLOA WHERE LOA002='XC' GROUP BY LOA001,LOA011 ) B ON A.LOA001=B.LOA001 AND A.LOA011=B.LOA011) A ON DEA001=A.LOA001 LEFT JOIN (SELECT SUM(HCB006) HCB006,HCB003 FROM DCSHCB WHERE HCB960 BETWEEN DATEADD(DAY,-1,GETDATE()) AND DATEADD(DAY,2,GETDATE()) GROUP BY HCB003) C ON DEA001=C.HCB003 LEFT JOIN (SELECT SUM(HCB006) HCB006,HCB003 FROM DCSHCB WHERE HCB960 BETWEEN DATEADD(DAY,2,GETDATE()) AND DATEADD(DAY,5,GETDATE()-1) GROUP BY HCB003) D ON DEA001=D.HCB003 LEFT JOIN (SELECT SUM(HCB006) HCB006,HCB003 FROM DCSHCB WHERE HCB960 BETWEEN DATEADD(DAY,5,GETDATE()-1) AND DATEADD(DAY,8,GETDATE()-1) GROUP BY HCB003) E ON DEA001=E.HCB003 LEFT JOIN (SELECT SUM(HCB006) HCB006,HCB003 FROM DCSHCB WHERE HCB960 >DATEADD(DAY,8,GETDATE()-1) GROUP BY HCB003) F ON DEA001=F.HCB003 LEFT JOIN DCSHCB G ON DEA001=G.HCB003 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=1 GROUP BY RCB004) H ON DEA001=H.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=2 GROUP BY RCB004) I ON DEA001=I.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=3 GROUP BY RCB004) J ON DEA001=J.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=4 GROUP BY RCB004) K ON DEA001=K.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=5 GROUP BY RCB004) L ON DEA001=L.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=6 GROUP BY RCB004) M ON DEA001=M.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=7 GROUP BY RCB004) N ON DEA001=N.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=8 GROUP BY RCB004) O ON DEA001=O.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=9 GROUP BY RCB004) P ON DEA001=P.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=10 GROUP BY RCB004) Q ON DEA001=Q.RCB004 LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=11 GROUP BY RCB004) R ON DEA001=R.RCB004  LEFT JOIN (SELECT SUM(RCB008) RCB008,RCB004 FROM SGMRCB A INNER JOIN SGMRCA B ON A.RCB001=B.RCA001 WHERE MONTH(RCA004)=12 GROUP BY RCB004) S ON DEA001=S.RCB004 WHERE DEA001 LIKE '2%' AND C.HCB006 IS NOT NULL" );

            return SqlHelper . ExecuteDataTable ( strSql . ToString ( ) );
        }

        /// <summary>
        /// 获取服务器日期
        /// </summary>
        /// <returns></returns>
        public DateTime getDt ( )
        {
            StringBuilder strSql = new StringBuilder ( );
            strSql . Append ( "SELECT GETDATE() dt" );
            DataTable dtTable = SqlHelper . ExecuteDataTable ( strSql . ToString ( ) );
            if ( dtTable != null && dtTable . Rows . Count > 0 )
            {
                if ( string . IsNullOrEmpty ( dtTable . Rows [ 0 ] [ "dt" ] . ToString ( ) ) )
                    return DateTime . Now;
                else
                    return Convert . ToDateTime ( dtTable . Rows [ 0 ] [ "dt" ] . ToString ( ) );
            }
            else
                return DateTime . Now;
        }

    }
}

